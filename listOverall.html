<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <title>‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</title>
  <link rel="icon" href="images/title.jpeg" type="image/png">
  <link rel="stylesheet" href="styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun&display=swap" rel="stylesheet">
  <style>
    /* üé® Modal Close Button Styling in Header */
    .modal-header {
      background: #4285f4;
      color: white;
      padding: 16px 20px;
      font-size: 20px;
      font-weight: bold;
      border-top-left-radius: 20px;
      border-top-right-radius: 20px;
      position: relative;
    }

    .modal-close-in-header {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 24px;
      font-weight: bold;
      color: white;
      cursor: pointer;
    }

    .modal-close-in-header:hover {
      color: #ffcccb;
    }
  </style>
</head>

<body>
  <header class="header">
    <div class="header-content">
      <img src="images/title.jpeg" class="header-icon" alt="School logo">
      <div>
        <h1 class="title">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</h1>
        <p class="subtitle">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏•‡∏ß‡∏±‡∏î‡∏´‡∏ô‡∏≠‡∏á‡∏Ç‡∏∏‡∏ô‡∏ä‡∏≤‡∏ï‡∏¥ (‡∏≠‡∏∏‡∏ó‡∏¥‡∏®‡∏û‡∏¥‡∏ó‡∏¢‡∏≤‡∏Ñ‡∏≤‡∏£)</p>
      </div>
    </div>
    <nav class="menu">
      <button onclick="window.location.href='index.html'">üë§ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <button class="active" onclick="window.location.href='listOverall.html'">üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      <button onclick="window.location.href='statistics.html'">üìä ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</button>
    </nav>
  </header>

  <div class="container">
    <h2 class="section-title">üìã ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>

    <div class="search-filter-bar">
      <div class="search-box">
        <span>üîç</span>
        <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..." />
      </div>
      <select id="transportFilter" class="select-filter">
        <option value="">‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option>‡∏£‡∏ñ‡∏¢‡∏ô‡∏ï‡πå‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</option>
        <option>‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô‡∏¢‡∏ô‡∏ï‡πå</option>
        <option>‡∏£‡∏ñ‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
        <option>‡∏£‡∏ñ‡πÇ‡∏î‡∏¢‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ó‡∏≤‡∏á</option>
        <option>‡πÄ‡∏î‡∏¥‡∏ô</option>
        <option>‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
      </select>
      <select id="gradeFilter" class="select-filter">
        <option value="">‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option>‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 1</option>
        <option>‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 2</option>
        <option>‡∏≠‡∏ô‡∏∏‡∏ö‡∏≤‡∏• 3</option>
        <option>‡∏õ.1</option>
        <option>‡∏õ.2</option>
        <option>‡∏õ.3</option>
        <option>‡∏õ.4</option>
        <option>‡∏õ.5</option>
        <option>‡∏õ.6</option>
      </select>
    </div>

    <div class="table-wrapper">
      <table id="studentTable">
        <thead>
          <tr>
            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
            <th>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</th>
            <th>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á</th>
            <th>‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÇ‡∏î‡∏¢</th>
            <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á</th>
            <th>‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
  <div id="footer-placeholder"></div>

  <!-- üßæ Modal -->
  <div id="studentModal" class="modal" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        <span class="modal-close modal-close-in-header" onclick="closeModal()">&times;</span>
      </div>
      <div class="modal-columns">
        <div class="modal-section blue" id="modalStudentInfo"></div>
        <div class="modal-section pink" id="modalTransportInfo"></div>
        <div class="modal-section purple" id="modalFriendInfo"></div>
      </div>
    </div>
  </div>

  <script>
    const urlGG = "https://script.google.com/macros/s/AKfycbzNflpVODFytMiDxKVe_3kpH2zWdCbaOLTOaC528YdjJfFis3eAN0xY8mtJuTglptry/exec"
    let allStudents = [];

    async function loadStudents() {
      const res = await fetch(urlGG);
      const json = await res.json();
      if (json.result !== "success") return alert("‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß");
      allStudents = json.data;
      renderTable(allStudents);
    }

    function renderTable(data) {
      const tbody = document.querySelector("#studentTable tbody");
      tbody.innerHTML = "";

      data.forEach(student => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${student.firstName} ${student.lastName}</td>
          <td>${student.nickname}</td>
          <td>${student.grade || "-"} / ${student.room || "-"}</td>
          <td>${student.transportation || "-"}</td>
          <td>${student.parentPhone || "-"}</td>
          <td>
            <button onclick='viewStudent(${JSON.stringify(student)})' title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">üîé</button>
            <!-- <button onclick='editStudent(${JSON.stringify(student)})' title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">‚úèÔ∏è</button> -->
            <!-- <button onclick='deleteStudent("${student.id}")' title="‡∏•‡∏ö">üóëÔ∏è</button> -->
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function deleteStudent(id) {
      if (!confirm("‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ?")) return;
      fetch(urlGG, {
          method: "POST",
          headers: {
            "Content-Type": "text/plain"
          },
          body: JSON.stringify({
            action: "delete",
            id
          })
        })
        .then(res => res.json())
        .then(data => {
          if (data.result === "success") {
            alert("‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß");
            loadStudents();
          } else {
            alert("‚ùå ‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + data.message);
          }
        });
    }

    function viewStudent(student) {
      document.getElementById("modalStudentInfo").innerHTML = `
        <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
        <p><span>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</span> ${student.firstName} ${student.lastName}</p>
        <p><span>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô:</span> ${student.nickname}</p>
        <p><span>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô/‡∏´‡πâ‡∏≠‡∏á:</span> ${student.grade || "-"} / ${student.room || "-"}</p>
        <p><span>‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà:</span> ${student.address || "-"}</p>
        <p><span>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á:</span> ${student.parentPhone || "-"}</p>
        <p><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠:</span> ${student.createdAt || "-"}</p>`;

      document.getElementById("modalTransportInfo").innerHTML = `
        <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</h3>
        <p><span>‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÇ‡∏î‡∏¢:</span> ${student.transportation || "-"}</p>
        <p><span>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ:</span> ${student.vehicleOwner || "-"}</p>
        <p><span>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ:</span> ${student.ownerPhone || "-"}</p>
        <p><span>‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ:</span> ${student.driverName || "-"}</p>
        <p><span>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏Ñ‡∏ô‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ:</span> ${student.driverPhone || "-"}</p>`;

      document.getElementById("modalFriendInfo").innerHTML = `
        <h3>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó</h3>
        ${(student.friendName || student.friendNickname || student.friendRoom || student.friendGrade) ? `
          <p><span>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</span> ${student.friendName}</p>
          <p><span>‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô:</span> ${student.friendNickname}</p>
          <p><span>‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏ä‡∏±‡πâ‡∏ô:</span> ${student.friendGrade}</p>
          <p><span>‡∏´‡πâ‡∏≠‡∏á:</span> ${student.friendRoom}</p>
        ` : '<p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó</p>'}`;

      document.getElementById("studentModal").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("studentModal").style.display = "none";
    }

    function editStudent(student) {
      localStorage.setItem("editStudent", JSON.stringify(student));
      window.location.href = "index.html";
    }

    document.getElementById("searchInput").addEventListener("input", () => {
      const q = document.getElementById("searchInput").value.toLowerCase();
      const filtered = allStudents.filter(s => `${s.firstName} ${s.lastName} ${s.nickname} ${s.driverName}`.toLowerCase().includes(q));
      renderTable(filtered);
    });

    document.getElementById("transportFilter").addEventListener("change", applyFilters);
    document.getElementById("gradeFilter").addEventListener("change", applyFilters);

    function applyFilters() {
      const trans = document.getElementById("transportFilter").value;
      const grade = document.getElementById("gradeFilter").value;

      let filtered = allStudents;
      if (trans) filtered = filtered.filter(s => s.transportation === trans);
      if (grade) filtered = filtered.filter(s => s.grade === grade);

      renderTable(filtered);
    }

    window.onload = loadStudents;

    window.addEventListener("DOMContentLoaded", () => {
      fetch("footer.html")
        .then(res => res.ok ? res.text() : Promise.reject("Footer not found"))
        .then(html => {
          document.getElementById("footer-placeholder").innerHTML = html;
        })
        .catch(err => {
          console.error("‚ö†Ô∏è Footer load error:", err);
        });
    });
  </script>
</body>

</html>